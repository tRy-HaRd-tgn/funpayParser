# Funpay Parser

Скрипт **funpay_parser.js** предназначен для перебора категорий на маркетплейсе [Funpay](https://funpay.com) и сохранения информации о лотах в CSV-файл.

Основные возможности:

1. Парсинг карточек лотов из переданных ссылок или всех категорий главной страницы.
2. Фильтрация результатов по языку и минимальной цене.
3. Конвертация цен из рублей в евро.
4. Загрузка изображений лота на Imgur (опционально).
5. Использование прокси для обхода ограничений Imgur.

---

## Установка

```bash
# 1. Клонируйте репозиторий
# 2. Перейдите в каталог проекта
npm install
```

Node.js версии 18+ необходим для корректной работы (используются ES-модули и fetch-совместимый Axios).

---

## Быстрый старт

```bash
node funpay_parser.js -u https://funpay.com/lots/12345 -l ru --output results.txt --verbose
```

---

## CLI-флаги

| Флаг                             | Значение по умолчанию | Описание                                                                                                                             |
| -------------------------------- | --------------------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| `--output <path>`                | `lots.txt`            | Путь к выходному CSV-файлу.                                                                                                          |
| `--delay-min <sec>`              | `1`                   | Минимальная пауза между запросами (в секундах).                                                                                      |
| `--delay-max <sec>`              | `2.5`                 | Максимальная пауза между запросами (в секундах).                                                                                     |
| `--rub-eur <rate>`               | `0.011`               | Курс конвертации из рублей в евро (1 ₽ → €).                                                                                         |
| `--lang, -l <ru\|en>`            | _пусто_               | Фильтрация лотов по языку (`ru` — только русскоязычные, `en` — только англоязычные).                                                 |
| `--url, -u <URL>`                | —                     | Ссылка на категорию/листинг Funpay. Может использоваться несколько раз. Также URL можно передавать позиционным аргументом без флага. |
| `--imgur-client-id <id>`         | —                     | Client-ID вашего приложения Imgur для загрузки изображений. Включает режим загрузки картинок.                                        |
| `--imgur-client-secret <secret>` | —                     | Client-Secret приложения Imgur (опционально, используется для расширенной авторизации).                                              |
| `--imgur-access-token <token>`   | —                     | Личный OAuth-токен Imgur (опционально).                                                                                              |
| `--upload-images`                | `false`               | Принудительно включить загрузку изображений (если Client-ID уже задан, включается автоматически).                                    |
| `--verbose, -v`                  | `false`               | Вывод дополнительной отладочной информации.                                                                                          |

### Замечания по флагам

1. **Паузы между запросами.** Значения `--delay-min` и `--delay-max` задаются в секундах; фактическая задержка выбирается случайно в диапазоне \[min,max]. Это помогает снизить вероятность блокировки за частые запросы.
2. **Курс рубль→евро.** Все цены в рублях конвертируются в евро, если флаг `--rub-eur` отличен от 0 и цена можно преобразовать в число.
3. **Фильтр языка.** Проверяется содержимое названия и описания лота. При значении `ru` пропускаются лоты без кириллицы; при `en` — лоты, содержащие кириллицу.
4. **Загрузка изображений.** Для работы необходим как минимум `--imgur-client-id` **или** переменная окружения `IMGUR_CLIENT_ID`. Скрипт скачивает не более 5 изображений на лот, а затем загружает их на Imgur через `curl`. Если в каталоге проекта существует `proxies.txt`, прокси используются ТОЛЬКО для запросов к Imgur и выбираются случайным образом из списка.

---

## Переменные окружения

| Переменная            | Назначение                            |
| --------------------- | ------------------------------------- |
| `IMGUR_CLIENT_ID`     | Аналогично флагу `--imgur-client-id`. |
| `IMGUR_CLIENT_SECRET` | Аналогично `--imgur-client-secret`.   |
| `IMGUR_ACCESS_TOKEN`  | Аналогично `--imgur-access-token`.    |

---

## Файл `proxies.txt`

Для обхода ограничений Imgur можно поместить в корень проекта файл `proxies.txt` с перечнем HTTP-прокси, по одному на строку. Допустимые форматы:

```
login:password@host:port
host:port
```

Прокси выбирается случайно для каждого запроса к Imgur. Для остальных доменов скрипт всегда обращается напрямую.

---

## Формат выходного CSV (UTF-8)

```
category;title;description;price;currency;lot_url;images
```

Поле `images` содержит прямые ссылки Imgur, разделённые символом `|`.

---

## Лицензия

MIT
